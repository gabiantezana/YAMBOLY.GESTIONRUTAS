@model YAMBOLY.GESTIONRUTAS.VIEWMODEL.GeoLocation.MapViewModel
@{
    ViewBag.Title = "TESTING";
    ViewBag.Icon = "users";
    ViewBag.Section = String.Empty;
    ViewBag.Subsection = String.Empty;
}

@*@section Breadcrumbs{

}*@

@using (Html.BeginForm("Testing", "Map", FormMethod.Post, new { id = "testingForm" }))
{
    @Html.HiddenFor(x => x.PostedShapeList)
    <div class="panel">
        <div clss="panel-body">
            <div class="row">
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="input-search" class="sr-only">Search Tree:</label>
                        <input type="input" class="form-control" id="input-search" placeholder="Buscar..." value="">
                    </div>
                    <div id="tree" class="treeview"></div>
                </div>
                <div class="col-md-10">
                    <input type="button" id="RemoveSelectedPolygon" value="Eliminar" onclick="RemoveSelectedPolygon(this)" style="display:none" />
                    <div>
                        <button  type="button" class="btn btn-sm btn-primary" id="createShapeButton" onclick="OnClickButton(BUTTONMODE.Create)">
                            <i class="fa fa-map-marker" aria-hidden="true"></i>&nbsp; Crear
                        </button>
                        <button type="button"  class="btn btn-sm btn-primary" id="editShapeButton" onclick="OnClickButton(BUTTONMODE.Edit)">
                            <i class="fa fa-pencil" aria-hidden="true"></i>&nbsp; Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" id="removeShapeButton" onclick="OnClickButton(BUTTONMODE.Remove)">
                            <i class="fa fa-trash" aria-hidden="true"></i>&nbsp; Eliminar
                        </button>

                        @*<input type="button" id="createShapeButton" value="Create shape" onclick="OnClickButton(BUTTONMODE.Create)" style="display:none" />*@
                        @*<input type="button" id="editShapeButton" value="Edit shape" onclick="OnClickButton(BUTTONMODE.Edit)" style="display:none" />
                        <input type="button" id="removeShapeButton" value="Remove shape" onclick="OnClickButton(BUTTONMODE.Remove)" style="display:none" />*@
                    </div>

                    <div style="display:none">
                        <input type="button" value="Crear zona" onclick="OnCreateClick()" />
                        <input type="button" value="Crear ruta" onclick="OnCreateClick()" />
                        <input type="button" id="CreateMarker" value="Crear marker" onclick="OnCreateClick()" />
                        <div id="showonPolygon"><b> Area:</b> <span id="areaPolygon">&nbsp700;</span></div>
                    </div>
                    <div id="map" style="width:1200px; height: 650px;"></div>
                </div>
                <div class="panel-footer text-right">
                    <button class="btn btn-primary" id="btnGuardar"><i class="fa fa-save" aria-hidden="true"></i>&nbsp; Guardar</button>
                </div>
            </div>
        </div>
      
    </div>
}
@section Scripts
{
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0hFla3KhpSUtpkjK7gqJVqfqUCI-7oFs&sensor=false&libraries=drawing"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="~/Scripts/bootstrap-treeview.js"></script>
    <script src="~/Areas/GeoLocation/Scripts/Testing.js"></script>
    <script src="~/Scripts/underscore.js"></script>

    <script>
        var polygonArray = [];
        var editedPolygonArray = [];
        var currentSelectedItem = null
        var currentSelectedShape = null;

        var map;
        var drawingManager;
        var jsonList;

        $(document).ready(function () {
            jsonList = @Html.Raw(Json.Encode(Model.ShapeList));
            CreateInputList(jsonList);
            InitializeMap();
            CreateShapes(jsonList);
        });

        function UpdateJsonList(jsonList) {
            var shapeInMap;
            jsonList.forEach(function (element) {
                shapeInMap  = _.findWhere(editedPolygonArray, { Id: element.Id });
                if (shapeInMap) {
                    switch (element.ShapeType) {
                        case SHAPETYPE.Zone:
                        case SHAPETYPE.Route:
                            if (shapeInMap.getPath()) 
                                element.GeoOptions = { paths: shapeInMap.getPath().getArray(), coords: null }
                            else
                                element.GeoOptions = { paths: null, coords: null }
                            break;
                        case SHAPETYPE.Client:
                            element.GeoOptions = { paths: null, coords: shapeInMap.getPosition() }
                            break;
                        default:
                            throw "Error";
                    }
                }
                else 
                    element.GeoOptions = { paths: null, coords: null }
                //
                if (element.nodes) {
                    UpdateJsonList(element.nodes);
                }
            });
        }

        $('#testingForm').submit(function () {
            UpdateJsonList(jsonList);
            /*
            var allZones = jsonList;
            var allRoutes = _.flatten(_.pluck(allZones, 'nodes'));
            var allClients = _.flatten(_.pluck(allRoutes, 'nodes'));
            //Actualiza coordenadas de polígonos en el array
            for (var i = 0; i < editedPolygonArray.length; i++) {
                var polygon = editedPolygonArray[i];
                var item;
                switch (polygon.ShapeType) {
                    case SHAPETYPE.Zone:
                        item = _.findWhere(jsonList, { Id: polygon.Id });
                        if (item)
                            item.GeoOptions = { paths: polygon.getPath().getArray(), coords: null }
                        break;
                    case SHAPETYPE.Route:
                        item = _.find(allRoutes, function (child) { return child.Id == polygon.Id });
                        if (item)
                            item.GeoOptions = { paths: polygon.getPath().getArray(), coords: null }
                        break;
                    case SHAPETYPE.Client:
                        debugger;
                        item = _.find(allClients, function (child) { return child.Id == polygon.Id });
                        if (item)
                            item.GeoOptions = { paths: null,  coords: polygon.getPosition() }
                        break;
                    default:
                        throw "Error";
                }

                if (!item) {
                    jsonList = _.without(jsonList, _.findWhere(jsonList , { id: 3 }));
                }
            }*/
            var dataToSend = JSON.stringify(jsonList);
            $("#PostedShapeList").val(dataToSend);
            return true;
        });

        function CreateInputList(jsonList) {
            var $searchableTree = $('#tree').treeview({
                data: jsonList,
            });

            $('#tree').on('nodeSelected', function (event, data) { onNodeClick(data) })
            //Search
            var search = function (e) {
                var pattern = $('#input-search').val();
                var options = {
                    ignoreCase: true,
                    exactMatch: false,
                    revealResults: true,
                };
                var results = $searchableTree.treeview('search', [pattern, options]);
                var output = '<p>' + results.length + ' matches found</p>';
                $.each(results, function (index, result) {
                    output += '<p>- ' + result.text + '</p>';
                });
                $('#search-output').html(output);
            }
            //Eventos buscar
            $('#btn-search').on('click', search);
            $('#input-search').on('keyup', search);
            $('#btn-clear-search').on('click', function (e) {
                $searchableTree.treeview('clearSearch');
                $('#input-search').val('');
                $('#search-output').html('');
            });
        }

        function InitializeMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: latLngCenterInit,
                zoom: 16,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            //Drawing manager
            drawingManager = new google.maps.drawing.DrawingManager(drawingManagerPolygonOptions);

            google.maps.event.addListener(drawingManager, 'polygoncomplete', function (polygon) {
                debugger;
                OnFinishDrawing(polygon);
            });
            google.maps.event.addListener(drawingManager, 'markercomplete', function (marker) {
                debugger;
                OnFinishDrawing(marker);
            });
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {
                debugger;
                var newShape = e.overlay;
                newShape.type = e.type;
                //setSelection(newShape);
                AddEventHandlersForShape(newShape);
                // Switch back to non-drawing mode after drawing a shape.
                drawingManager.setDrawingMode(null);
            });
            //google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);
            //google.maps.event.addListener(map, 'click', clearSelection);
        }

        function CreateShapes(json) {
            json.forEach(function (element) {
                if (element.GeoOptions)
                    DrawShape(element);
                if (element.nodes) {
                    CreateShapes(element.nodes);
                }
            });

            //Create a copy of rendered polygons in editedPolygons
            editedPolygonArray = polygonArray;
        }

        //Render shapes from model.
        function DrawShape(item) {
            switch (item.ShapeType)
            {
                case SHAPETYPE.Zone:
                    var coords = item.GeoOptions.paths;
                    console.log(item)
                    var polygon = new google.maps.Polygon({
                        clickable: true,
                        draggable: false,
                        editable: false,
                        fillColor: "yellow",//TODO:
                        fillOpacity: 0.1,//TODO:
                        strokeWeight: 0.9, //TODO:
                        visible: true,
                        paths: coords,
                    });

                    AddAditionalPropertiesToPolygon(item, polygon);
                    AddEventHandlersForShape(polygon);
                    polygon.setMap(map);
                    polygonArray.push(polygon);
                    break;
                case SHAPETYPE.Route:
                    var coords = item.GeoOptions.paths;
                    console.log(item)
                    var polygon = new google.maps.Polygon({
                        clickable: true,
                        draggable: false,
                        editable: false,
                        fillColor: GetRandomColor(),
                        fillOpacity: 0.40,//TODO:
                        strokeWeight: 0.5, //TODO:
                        visible: true,
                        paths: coords,
                        //zindex = 10,
                    });

                    AddAditionalPropertiesToPolygon(item, polygon);
                    AddEventHandlersForShape(polygon);
                    polygon.setMap(map);
                    polygonArray.push(polygon);
                    break;
                case SHAPETYPE.Client:
                    debugger;
                    var marker = new google.maps.Marker({
                        position: item.GeoOptions.coords,
                        map: map,
                        title: item.text,
                        label: {
                            text: item.text,
                            color: 'black',
                            fontWeight: "",
                            fontSize: "13px"
                        }
                    });
                    AddAditionalPropertiesToPolygon(item, marker);
                    AddEventHandlersForShape(marker);
                    polygonArray.push(marker);
                    break;
                default:
                    throw "Invalid shapeType";
            }
        }

        function GetShapeFromMap(shapeId) {
            return _.findWhere(editedPolygonArray, { Id: shapeId });
        }

        function AddAditionalPropertiesToPolygon(item, shape) {
            shape.Id = item.Id;
            shape.Name = item.Name;
            shape.ShapeType = item.ShapeType;
            if (shape.ShapeType == SHAPETYPE.Route|| shape.ShapeType == SHAPETYPE.Client)
                shape.ParentId = item.ParentId;

        }

        function AddEventHandlersForShape(shape) {
            console.log(shape.type);
            google.maps.event.addListener(shape, 'click', function () {
                ShowShapeInfo(shape.Id, shape.ShapeType);
                //setSelection(shape);
            });

        }

        function OnClickButton(_buttonMode) {
            var shapeType = currentSelectedItem.ShapeType;
            var shape = GetShapeFromMap(currentSelectedItem.Id);
            var drawingMode;
            switch (_buttonMode) {
                case BUTTONMODE.Create:
                    if (shape)
                        throw "No se puede crear, ya existe en el mapa";
                    switch (shapeType) {
                        case SHAPETYPE.Zone:
                            drawingManager.setOptions({
                                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                                polygonOptions: polygonOptionsZone
                            });
                            break;
                        case SHAPETYPE.Route:
                            drawingManager.setOptions({
                                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                                polygonOptions: polygonOptionsRoute
                            });
                            break;
                        case SHAPETYPE.Client:
                            drawingManager.setOptions({
                                drawingMode: google.maps.drawing.OverlayType.MARKER,
                            });
                            break;
                        default:
                            throw "No se reconoce el tipo de forma";
                    }
                    drawingManager.setMap(map);
                    break;
                case BUTTONMODE.Edit:
                    if (!shape)
                        throw "No se puede editar, la forma no existe en el mapa.";
                    setSelection(shape);
                    break;
                case BUTTONMODE.Remove:
                    setSelection(shape);
                    RemoveSelectedPolygon();
                    EvaluateSelectedItem();
                    break;
                default:
                    throw "Error button mode";
                    break;
            }
        }

        function onNodeClick(data) {
            clearSelection();
            currentSelectedItem = data;
            EvaluateSelectedItem();
        }

        function EvaluateSelectedItem() {
            var prefixTitle;
            var shapeType = currentSelectedItem.ShapeType;
            switch (currentSelectedItem.ShapeType) {
                case SHAPETYPE.Zone:
                    prefixTitle = " zona";
                    break;
                case SHAPETYPE.Route:
                    prefixTitle = " ruta";
                    break;
                case SHAPETYPE.Client:
                    prefixTitle = " cliente";
                    break;
                default:
                    throw "Invalid shape";
            }

            $("#editShapeButton").html("Editar " + prefixTitle);
            $("#removeShapeButton").html("Eliminar " + prefixTitle);
            $("#createShapeButton").html("Crear" + prefixTitle);

            var shape = GetShapeFromMap(currentSelectedItem.Id);
            if (shape) {
                currentSelectedShape = shape;
                //---------Activa efecto zoom en el mapa---------
                switch (currentSelectedItem.ShapeType) {
                    case SHAPETYPE.Zone:
                    case SHAPETYPE.Route:
                        map.panTo(GetPolygonCenter(shape));
                        break;
                    case SHAPETYPE.Client:
                        map.panTo(shape.getPosition());
                        break;
                    default:
                        throw "Invalid shape";
                }


                $("#editShapeButton").slideDown();
                $("#removeShapeButton").slideDown();
                $("#createShapeButton").slideUp();
            }
            else {
                currentSelectedShape = null;
                $("#createShapeButton").slideDown();
                $("#editShapeButton").slideUp();
                $("#removeShapeButton").slideUp();
            }
        }

        function OnFinishDrawing(shape) {
            debugger;
            currentSelectedShape = shape;
            AddAditionalPropertiesToPolygon(currentSelectedItem, shape);

            var isAValidShape = IsAValidShape(shape);
            if (isAValidShape) {
                editedPolygonArray.push(shape);
            }
            else {
                RemoveSelectedPolygon();
                shape.setMap(null);
            }

            EvaluateSelectedItem();
        }

        function ShowShapeInfo(id, shapeType) {
            $.ajax({
                cache: false,
                url: '@Url.Action("GetShapeInfo", "Map", new { Area = ConstantHelper.Area.GEOLOCATION})',
                type: 'POST',
                data: { 'id': id, 'shapeType': shapeType },
                success: function (data) {
                    console.log(data);
                    //TODO: SHOW MESSAGE
                },
                error: function (error) {
                    console.log(error);
                    ShowMessage(error.statusText, error.responseJSON);
                }
            })
        }

    </script>
    <style>
        .list-group-item {
            padding: 3px 3px;
        }
        body {
            font-size: 13px;
        }

        #floating-div {
            position: absolute;
            top: 10px;
            left: 25%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }
    </style>
}
